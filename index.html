<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-title" content="Maintenance"/>
  <title>Vehicle Maintenance Tracker</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{font-family:system-ui,-apple-system,sans-serif;background:#f8f9fa;max-width:480px;margin:0 auto;min-height:100vh;padding-bottom:72px}
    .header{background:#100299;color:#fff;padding:16px;position:sticky;top:0;z-index:100}
    .header-row{display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:20px;font-weight:700}
    .header p{font-size:12px;opacity:.8;margin-top:2px}
    .nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e5e7eb;z-index:100;max-width:480px;margin:0 auto}
    .nav button{flex:1;padding:10px 4px 8px;border:none;background:none;font-size:11px;color:#6b7280;cursor:pointer;border-top:2px solid transparent;font-weight:500}
    .nav button.active{color:#100299;border-top-color:#100299;font-weight:700;background:#f0f0ff}
    .section{padding:12px 16px}
    .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .badge{display:inline-block;border-radius:99px;padding:2px 8px;font-size:11px;font-weight:600;color:#fff;white-space:nowrap}
    .badge-red{background:#dc2626}.badge-yellow{background:#f59e0b}.badge-blue{background:#3b82f6}.badge-green{background:#16a34a}.badge-gray{background:#6b7280}
    .summary-row{display:flex;gap:8px;margin-bottom:4px}
    .summary-box{flex:1;border-radius:10px;padding:12px;text-align:center;color:#fff}
    .summary-box .num{font-size:28px;font-weight:800;line-height:1}
    .summary-box .lbl{font-size:11px;margin-top:2px}
    .btn{display:block;width:100%;padding:11px 16px;border-radius:8px;border:none;font-size:14px;font-weight:600;cursor:pointer;margin-top:8px;text-align:center}
    .btn-primary{background:#100299;color:#fff}.btn-outline{background:#fff;color:#100299;border:1.5px solid #100299}.btn-danger{background:#dc2626;color:#fff}.btn-ghost{background:#f3f4f6;color:#374151}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .small-btn{background:none;border:1.5px solid currentColor;border-radius:6px;padding:5px 11px;font-size:12px;font-weight:600;cursor:pointer}
    .small-btn-green{color:#16a34a}.small-btn-blue{color:#100299}.small-btn-red{color:#dc2626}.small-btn-white{color:#fff;border-color:rgba(255,255,255,.5)}.small-btn-gray{color:#6b7280}
    label{display:block;font-size:13px;font-weight:600;color:#374151;margin-top:12px}
    input,select{width:100%;border:1.5px solid #d1d5db;border-radius:8px;padding:10px 12px;font-size:15px;margin-top:4px;background:#fff;font-family:inherit}
    .task-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .task-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
    .task-title{font-weight:700;font-size:15px}
    .task-meta{font-size:12px;color:#6b7280;margin-top:3px}
    .task-notes{font-size:12px;color:#9ca3af;margin-top:2px}
    .task-supplies{font-size:12px;color:#100299;margin-top:2px}
    .section-label{font-weight:700;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
    .empty{color:#9ca3af;text-align:center;margin-top:24px;font-size:14px}
    .chevron{font-size:20px;color:#9ca3af}
    .hint{font-size:12px;color:#6b7280;margin-top:4px;line-height:1.5}
    #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 20px;border-radius:99px;font-size:13px;font-weight:600;z-index:999;white-space:nowrap;display:none}
    .error-text{color:#dc2626;font-size:13px;margin-top:8px}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:flex-end;justify-content:center}
    .modal{background:#fff;border-radius:16px 16px 0 0;padding:20px 20px 32px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
    .modal h2{font-size:17px;font-weight:700;margin-bottom:2px}
    .modal .sub{font-size:13px;color:#6b7280;margin-bottom:4px}
    .pill{display:inline-block;background:#f0f0ff;color:#100299;border-radius:99px;padding:3px 10px;font-size:12px;font-weight:600;margin:2px 2px 0 0}
    .divider{height:1px;background:#f0f0f0;margin:16px 0}
    .edit-icon{font-size:16px;cursor:pointer;padding:4px;opacity:.6}
    .edit-icon:hover{opacity:1}
  </style>
</head>
<body>
<div id="toast"></div>
<div id="modal"></div>
<div id="app"></div>
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HARDCODED_URL = "";
const URL_KEY = "vmtracker_v3";
let SCRIPT_URL = HARDCODED_URL || localStorage.getItem(URL_KEY) || "";

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let vehicles = [], records = [], syncing = false;
let view = SCRIPT_URL ? "loading" : "setup";
let selVid = null;
let logRec = null;
let editVehicle = null;
let editRecord  = null;
let customPresets = {};      // overrides from sheet: { "Pickup": [...], "Boat": [...] }
let settingsTab = "type";    // "type" | vehicle id

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VEHICLE_TYPES = ["Pickup","Car","RV","Boat","Tractor","Go-Kart","Trailer","Other"];
const TRACKING = { Pickup:"miles",Car:"miles",RV:"miles",Boat:"hours",Tractor:"hours","Go-Kart":"hours",Trailer:"date",Other:"ask" };
// Default presets â€” overridden by customPresets if set
const DEFAULT_PRESETS = {
  Pickup:   ["Oil Change","Tire Rotation","Air Filter","Brake Inspection","Transmission Service","Coolant Flush"],
  Car:      ["Oil Change","Tire Rotation","Air Filter","Brake Inspection","Transmission Service"],
  RV:       ["Oil Change","Generator Service","Roof Seal","Battery Check","Winterize","De-Winterize"],
  Boat:     ["Engine Service","Impeller Replacement","Winterize","De-Winterize","Fuel Stabilizer","Battery Check"],
  Tractor:  ["Oil Change","Air Filter","Hydraulic Fluid","Belt Inspection","Blade Sharpen"],
  "Go-Kart":["Oil Change","Chain Lube","Brake Check","Tire Check"],
  Trailer:  ["Bearing Repack","Brake Check","Tire Inspection","Light Check"],
  Other:    ["Service","Inspection","Oil Change"],
};
const PRESETS_KEY = "vmtracker_presets";

function getPresets(typeOrVid) {
  // Per-vehicle presets take priority, then type presets, then defaults
  if (customPresets[typeOrVid]?.length) return customPresets[typeOrVid];
  const v = vehicles.find(x=>x.id===typeOrVid);
  if (v && customPresets[v.type]?.length) return customPresets[v.type];
  if (v) return DEFAULT_PRESETS[v.type] || DEFAULT_PRESETS.Other;
  return customPresets[typeOrVid] || DEFAULT_PRESETS[typeOrVid] || DEFAULT_PRESETS.Other;
}
const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
let rf = { vehicleId:"", triggerType:"Every X Days", customMode:false };

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const genId = () => Date.now().toString(36) + Math.random().toString(36).slice(2,5);
const daysUntil = d => d ? Math.ceil((new Date(d) - new Date()) / 86400000) : null;
const fmtDate = d => d ? new Date(d).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}) : "â€”";
const fNum = n => isNaN(parseFloat(n)) ? "" : parseFloat(n).toLocaleString();
const unit = tt => tt==="miles"?"mi":tt==="hours"?"hrs":"";
const esc = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;");

function nextSeasonal(month) {
  const now = new Date(), t = new Date(now.getFullYear(), parseInt(month), 1);
  return (t <= now ? new Date(now.getFullYear()+1, parseInt(month), 1) : t).toISOString().slice(0,10);
}
function calcNextDueDate(r) {
  if (r.triggerType==="Seasonal (Month)") return nextSeasonal(r.seasonalMonth);
  if (r.triggerType==="Every X Days" && r.intervalDays && r.lastDate) {
    const d = new Date(r.lastDate); d.setDate(d.getDate()+parseInt(r.intervalDays));
    return d.toISOString().slice(0,10);
  }
  return r.nextDueDate||"";
}
function calcNextDueUsage(r) {
  if ((r.triggerType==="Miles"||r.triggerType==="Hours") && r.lastUsage && r.usageInterval)
    return String(parseFloat(r.lastUsage) + parseFloat(r.usageInterval));
  return r.nextDueUsage||"";
}

function vm() { return Object.fromEntries(vehicles.map(v=>[v.id,v])); }

function estimateDays(r) {
  const v = vm()[r.vehicleId];
  if (r.triggerType==="Miles"||r.triggerType==="Hours") {
    if (!r.nextDueUsage||!v?.avgWeeklyUsage||!v?.currentUsage) return null;
    const rem = parseFloat(r.nextDueUsage) - parseFloat(v.currentUsage);
    if (rem <= 0) return -1;
    return Math.round((rem / parseFloat(v.avgWeeklyUsage)) * 7);
  }
  return r.nextDueDate ? daysUntil(r.nextDueDate) : null;
}

function dueLabel(r) {
  if (r.triggerType==="Miles"&&r.nextDueUsage) return `Due at ${fNum(r.nextDueUsage)} mi`;
  if (r.triggerType==="Hours"&&r.nextDueUsage) return `Due at ${fNum(r.nextDueUsage)} hrs`;
  if (r.nextDueDate) return fmtDate(r.nextDueDate);
  return "Not scheduled";
}

function badgeClass(d) {
  if (d===null) return "badge-gray";
  if (d<0||d<=7) return "badge-red";
  if (d<=14) return "badge-yellow";
  if (d<=30) return "badge-blue";
  return "badge-green";
}
function badgeLabel(d) {
  if (d===null) return "No schedule";
  if (d<0) return `Overdue ${Math.abs(d)}d`;
  if (d===0) return "Due today";
  return `Due in ${d}d`;
}

function sorted(vid=null) {
  let rs = vid ? records.filter(r=>r.vehicleId===vid) : [...records];
  return rs.sort((a,b)=>(estimateDays(a)??9999)-(estimateDays(b)??9999));
}

function showToast(msg) {
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  clearTimeout(t._t); t._t=setTimeout(()=>t.style.display="none",3000);
}

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(action, body={}) {
  if (!SCRIPT_URL) throw new Error("No script URL.");
  const res = await fetch(SCRIPT_URL+"?action="+action, {
    method:"POST", body:JSON.stringify({action,...body})
  });
  const txt = await res.text();
  try { return JSON.parse(txt); }
  catch { throw new Error("Bad response: "+txt.slice(0,150)); }
}

async function loadAll() {
  const res  = await fetch(SCRIPT_URL+"?action=getAll");
  const data = JSON.parse(await res.text());
  if (data.error) throw new Error(data.error);
  vehicles = data.vehicles||[];
  records  = data.records||[];
  // Merge server presets with local
  if (data.presets && Object.keys(data.presets).length) {
    customPresets = data.presets;
    localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
  } else {
    customPresets = JSON.parse(localStorage.getItem(PRESETS_KEY)||"{}");
  }
}

// â”€â”€ ROUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(v, vid=null) {
  view=v; if(vid!==null) selVid=vid;
  closeModal(); render(); window.scrollTo(0,0);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  document.getElementById("app").innerHTML = ({
    loading:"rLoading", setup:"rSetup", dashboard:"rDashboard",
    vehicles:"rVehicles", "add-vehicle":"rAddVehicle", "edit-vehicle":"rEditVehicle",
    "add-record":"rAddRecord", "edit-record":"rEditRecord", "vehicle-detail":"rDetail",
  }[view]||"rDashboard").split("").reduce((f,c)=>f,window[{
    loading:"rLoading", setup:"rSetup", dashboard:"rDashboard",
    vehicles:"rVehicles", "add-vehicle":"rAddVehicle", "edit-vehicle":"rEditVehicle",
    "add-record":"rAddRecord", "edit-record":"rEditRecord", "vehicle-detail":"rDetail",
  }[view]||"rDashboard"])();
}

// cleaner dispatch
const VIEWS = {
  loading:rLoading, setup:rSetup, dashboard:rDashboard, vehicles:rVehicles,
  "add-vehicle":rAddVehicle, "edit-vehicle":rEditVehicle,
  "add-record":rAddRecord, "edit-record":rEditRecord,
  "vehicle-detail":rDetail, settings:rSettings,
};
function render() {
  document.getElementById("app").innerHTML = (VIEWS[view]||rDashboard)();
}

function nav(active) {
  return `<nav class="nav">
    <button class="${active==="dashboard"?"active":""}" onclick="go('dashboard')">ğŸ  Home</button>
    <button class="${active==="add-record"?"active":""}" onclick="go('add-record')">ï¼‹ Task</button>
    <button class="${active==="vehicles"?"active":""}" onclick="go('vehicles')">ğŸš— Fleet</button>
    <button class="${active==="settings"?"active":""}" onclick="go('settings')">âš™ï¸ Settings</button>
  </nav>`;
}

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rLoading() {
  return `<div class="header"><h1>Maintenance Tracker</h1><p>Loadingâ€¦</p></div>
  <div class="section" style="text-align:center;margin-top:48px;color:#9ca3af">Connecting to Google Sheetâ€¦</div>`;
}

function rSetup() {
  return `
  <div class="header"><h1>Maintenance Tracker</h1><p>One-time setup</p></div>
  <div class="section">
    <div class="card">
      <p style="font-weight:700;font-size:16px;margin-bottom:8px">Connect Your Google Sheet</p>
      <p style="font-size:13px;color:#6b7280;margin-bottom:12px">Do this once. Your URL is saved in this browser.</p>
      <div style="font-size:13px;line-height:2.1">
        <b>1.</b> Open your Google Sheet â†’ Extensions â†’ Apps Script<br>
        <b>2.</b> Paste the Apps Script code â†’ Save<br>
        <b>3.</b> Deploy â†’ New Deployment â†’ Web app<br>
        <b>4.</b> Execute as: <b>Me</b> &nbsp;Â·&nbsp; Access: <b>Anyone</b><br>
        <b>5.</b> Authorize â†’ Copy Web App URL â†’ paste below
      </div>
    </div>
    <div id="setup-err" class="error-text"></div>
    <label>Web App URL</label>
    <input id="url-in" type="url" placeholder="https://script.google.com/macros/s/â€¦/exec"/>
    <button class="btn btn-primary" onclick="connectSheet()">Connect &amp; Load Data</button>
  </div>`;
}

async function connectSheet() {
  const url=(document.getElementById("url-in").value||"").trim();
  const err=document.getElementById("setup-err");
  if (!url.startsWith("https://script.google.com")){err.textContent="Doesn't look like a Script URL.";return;}
  SCRIPT_URL=url; err.textContent=""; view="loading"; render();
  try {
    await loadAll(); localStorage.setItem(URL_KEY,SCRIPT_URL); go("dashboard");
  } catch(e) {
    SCRIPT_URL=""; view="setup"; render();
    document.getElementById("setup-err").textContent="Connection failed: "+e.message;
  }
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rDashboard() {
  const sr=sorted(), vmap=vm();
  const overdue=sr.filter(r=>{const d=estimateDays(r);return d!==null&&d<0;}).length;
  const soon   =sr.filter(r=>{const d=estimateDays(r);return d!==null&&d>=0&&d<=30;}).length;
  const tasks = sr.length===0
    ? `<p class="empty">No tasks yet â€” add a vehicle and set up maintenance tasks.</p>`
    : sr.map(r=>{
        const v=vmap[r.vehicleId]||{}, d=estimateDays(r);
        return `<div class="card" style="cursor:pointer" onclick="go('vehicle-detail','${r.vehicleId}')">
          <div class="task-row">
            <div style="flex:1">
              <div class="task-title">${esc(r.task)}</div>
              <div class="task-meta">${esc(v.name||"?")} Â· ${dueLabel(r)}</div>
            </div>
            <span class="badge ${badgeClass(d)}">${badgeLabel(d)}</span>
          </div>
          <div class="task-actions" onclick="event.stopPropagation()">
            <button class="small-btn small-btn-green" onclick="openLog('${r.id}')">âœ“ Log Done</button>
            ${r.nextDueDate?`<button class="small-btn small-btn-blue" onclick="openCal('${r.id}')">ğŸ“… Cal</button>`:""}
          </div>
        </div>`;
      }).join("");

  return `
  <div class="header">
    <div class="header-row">
      <div><h1>Maintenance Tracker</h1><p>${vehicles.length} vehicles Â· ${records.length} tasks${syncing?" Â· savingâ€¦":""}</p></div>
      <button class="small-btn small-btn-white" onclick="go('add-vehicle')">ï¼‹ Vehicle</button>
    </div>
  </div>
  <div class="section">
    <div class="summary-row">
      <div class="summary-box" style="background:#dc2626"><div class="num">${overdue}</div><div class="lbl">Overdue</div></div>
      <div class="summary-box" style="background:#f59e0b"><div class="num">${soon}</div><div class="lbl">Due â‰¤30d</div></div>
      <div class="summary-box" style="background:#100299"><div class="num">${vehicles.length}</div><div class="lbl">Vehicles</div></div>
    </div>
    ${vehicles.length===0
      ?`<div style="text-align:center;margin-top:32px">
          <p style="font-size:18px;font-weight:700;color:#100299;margin-bottom:8px">Connected!</p>
          <p style="color:#6b7280;margin-bottom:16px">Start by adding your vehicles.</p>
          <button class="btn btn-primary" onclick="go('add-vehicle')">Add First Vehicle</button>
        </div>`
      :`<div class="section-label" style="margin-top:14px">All Tasks Â· Sorted by Urgency</div>${tasks}`}
  </div>
  ${nav("dashboard")}`;
}

// â”€â”€ FLEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rVehicles() {
  const rows = vehicles.map(v=>{
    const vr=records.filter(r=>r.vehicleId===v.id);
    const urgent=vr.filter(r=>{const d=estimateDays(r);return d!==null&&d<=14;}).length;
    const u=unit(v.trackingType);
    return `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center" onclick="go('vehicle-detail','${v.id}')" style="cursor:pointer">
        <div style="flex:1;cursor:pointer" onclick="go('vehicle-detail','${v.id}')">
          <div style="font-weight:700">${esc(v.name)}</div>
          <div style="font-size:12px;color:#6b7280;margin-top:2px">${v.year?esc(v.year)+" ":""}${esc(v.type)} Â· ${vr.length} task${vr.length!==1?"s":""}</div>
          ${v.currentUsage&&u?`<div style="margin-top:4px"><span class="pill">ğŸ“ ${fNum(v.currentUsage)} ${u}</span>${v.avgWeeklyUsage?`<span class="pill">~${fNum(v.avgWeeklyUsage)} ${u}/wk</span>`:""}</div>`:""}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${urgent>0?`<span class="badge badge-yellow">${urgent} soon</span>`:""}
          <button class="small-btn small-btn-gray" onclick="event.stopPropagation();openEditVehicle('${v.id}')">âœï¸ Edit</button>
          <span class="chevron" onclick="go('vehicle-detail','${v.id}')">â€º</span>
        </div>
      </div>
    </div>`;
  }).join("");

  return `
  <div class="header">
    <div class="header-row"><h1>Fleet</h1>
      <button class="small-btn small-btn-white" onclick="go('add-vehicle')">ï¼‹ Add</button>
    </div>
  </div>
  <div class="section">
    ${vehicles.length===0?`<p class="empty">No vehicles yet.</p>`:rows}
    <button class="btn btn-primary" onclick="go('add-vehicle')">ï¼‹ Add Vehicle</button>
  </div>
  ${nav("vehicles")}`;
}

// â”€â”€ ADD VEHICLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rAddVehicle() {
  return vehicleForm(null);
}

// â”€â”€ EDIT VEHICLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditVehicle(id) {
  editVehicle = vehicles.find(v=>v.id===id);
  go("edit-vehicle");
}

function rEditVehicle() {
  if (!editVehicle) { go("vehicles"); return ""; }
  return vehicleForm(editVehicle);
}

function vehicleForm(v) {
  const isEdit = !!v;
  const typeOpts = VEHICLE_TYPES.map(t=>`<option ${v?.type===t?"selected":""}>${t}</option>`).join("");
  const tracking = v ? v.trackingType : "miles";
  const showUsage = tracking!=="date";

  return `
  <div class="header">
    <div class="header-row"><h1>${isEdit?"Edit Vehicle":"Add Vehicle"}</h1>
      <button class="small-btn small-btn-white" onclick="go(${isEdit?`'vehicles'`:`'vehicles'`})">Cancel</button>
    </div>
  </div>
  <div class="section">
    <label>Name *</label>
    <input id="vn" value="${esc(v?.name||"")}" placeholder="e.g. Blue Pickup, Bass Boat"/>
    <label>Type</label>
    <select id="vt" onchange="onVType(this.value)">${typeOpts}</select>
    <div id="vtrack" class="hint" style="margin-top:6px">ğŸ“ Tracking: ${tracking==="miles"?"Miles (odometer)":tracking==="hours"?"Engine Hours":"Date only"}</div>
    <div id="vusage-wrap" style="${showUsage?"":"display:none"}">
      <label id="vcur-lbl">Current ${tracking==="hours"?"Engine Hours":"Odometer (miles)"}</label>
      <input id="vcur" type="number" value="${esc(v?.currentUsage||"")}" placeholder="${tracking==="hours"?"e.g. 250":"e.g. 45000"}"/>
      <label id="vavg-lbl">Estimated Weekly ${tracking==="hours"?"Hours":"Miles"} <span style="font-weight:400;color:#9ca3af">(starting estimate)</span></label>
      <input id="vavg" type="number" value="${esc(v?.avgWeeklyUsage||"")}" placeholder="${tracking==="hours"?"e.g. 5":"e.g. 150"}"/>
      <p class="hint">Auto-recalculates from your service logs over time.</p>
    </div>
    <div id="vcustom-wrap" style="display:none">
      <label>Tracking Type</label>
      <select id="vctype">
        <option value="miles" ${tracking==="miles"?"selected":""}>Miles (odometer)</option>
        <option value="hours" ${tracking==="hours"?"selected":""}>Hours (engine hours)</option>
        <option value="date"  ${tracking==="date" ?"selected":""}>Date only</option>
      </select>
    </div>
    <label>Year (optional)</label>
    <input id="vyr" type="number" value="${esc(v?.year||"")}" placeholder="2020"/>
    <label>Notes (optional)</label>
    <input id="vnotes" value="${esc(v?.notes||"")}" placeholder="e.g. 6.7L diesel, red kart"/>
    <div id="verr" class="error-text"></div>
    <button class="btn btn-primary" onclick="${isEdit?"updateVehicle()":"saveVehicle()"}">
      ${isEdit?"Save Changes":"Add Vehicle"}
    </button>
    ${isEdit?`<button class="btn btn-danger" onclick="delVehicle('${v.id}')">Delete Vehicle &amp; All Tasks</button>`:""}
  </div>
  ${nav("")}`;
}

function onVType(type) {
  const t=TRACKING[type]||"ask";
  const info=document.getElementById("vtrack");
  const uw=document.getElementById("vusage-wrap");
  const cw=document.getElementById("vcustom-wrap");
  const cl=document.getElementById("vcur-lbl");
  const al=document.getElementById("vavg-lbl");
  const ci=document.getElementById("vcur");
  const ai=document.getElementById("vavg");
  if(t==="miles"){
    info.textContent="ğŸ“ Tracking: Miles (odometer)";
    uw.style.display="";cw.style.display="none";
    cl.textContent="Current Odometer (miles)";ci.placeholder="e.g. 45000";
    al.innerHTML='Estimated Weekly Miles <span style="font-weight:400;color:#9ca3af">(starting estimate)</span>';
    ai.placeholder="e.g. 150";
  } else if(t==="hours"){
    info.textContent="ğŸ“ Tracking: Engine Hours";
    uw.style.display="";cw.style.display="none";
    cl.textContent="Current Engine Hours";ci.placeholder="e.g. 250";
    al.innerHTML='Estimated Weekly Hours <span style="font-weight:400;color:#9ca3af">(starting estimate)</span>';
    ai.placeholder="e.g. 5";
  } else if(t==="date"){
    info.textContent="ğŸ“ Tracking: Date only";
    uw.style.display="none";cw.style.display="none";
  } else {
    info.textContent="ğŸ“ Custom tracking";
    uw.style.display="none";cw.style.display="block";
  }
}

function collectVehicleForm(existingId) {
  const type=document.getElementById("vt").value;
  const rawT=TRACKING[type]||"ask";
  const trackingType=rawT==="ask"?(document.getElementById("vctype")||{value:"miles"}).value:rawT;
  return {
    id: existingId||genId(), name:(document.getElementById("vn").value||"").trim(),
    type, trackingType, year:document.getElementById("vyr").value,
    notes:document.getElementById("vnotes").value,
    currentUsage:(document.getElementById("vcur")||{value:""}).value,
    avgWeeklyUsage:(document.getElementById("vavg")||{value:""}).value,
    lastLoggedUsage: editVehicle?.lastLoggedUsage||"",
    lastLoggedDate:  editVehicle?.lastLoggedDate||"",
  };
}

async function saveVehicle() {
  const v=collectVehicleForm(null);
  if (!v.name){document.getElementById("verr").textContent="Name is required.";return;}
  syncing=true;
  try {
    const r=await api("saveVehicle",{vehicle:v});
    if(r.error) throw new Error(r.error);
    vehicles.push(v); showToast(`${v.name} added!`); go("vehicles");
  } catch(e){showToast("Save failed: "+e.message);}
  syncing=false;
}

async function updateVehicle() {
  if (!editVehicle) return;
  const v=collectVehicleForm(editVehicle.id);
  if (!v.name){document.getElementById("verr").textContent="Name is required.";return;}
  syncing=true;
  try {
    const r=await api("updateVehicle",{vehicle:v});
    if(r.error) throw new Error(r.error);
    vehicles=vehicles.map(x=>x.id===v.id?v:x);
    editVehicle=null; showToast("Vehicle updated!"); go("vehicles");
  } catch(e){showToast("Save failed: "+e.message);}
  syncing=false;
}

// â”€â”€ ADD RECORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rAddRecord() {
  return recordForm(null);
}

// â”€â”€ EDIT RECORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditRecord(id) {
  editRecord = records.find(r=>r.id===id);
  if (!editRecord) return;
  rf.vehicleId   = editRecord.vehicleId;
  rf.triggerType = editRecord.triggerType;
  rf.customMode  = false;
  go("edit-record");
}

function rEditRecord() {
  if (!editRecord) { go("vehicle-detail"); return ""; }
  return recordForm(editRecord);
}

function recordForm(rec) {
  const isEdit = !!rec;
  const preVid = rec?.vehicleId || rf.vehicleId || selVid || "";
  const sv = vehicles.find(v=>v.id===preVid)||vehicles[0];
  const vOpts = vehicles.map(v=>`<option value="${v.id}" ${v.id===preVid?"selected":""}>${esc(v.name)}</option>`).join("");
  const taskOpts = sv?(getPresets(sv.id)||[]).map(t=>`<option ${(rec?.task||rf.savedTask)===t?"selected":""}>${t}</option>`).join(""):"";
  const tt = rec?.triggerType||rf.triggerType;
  const today = new Date().toISOString().slice(0,10);
  const monthOpts = MONTHS.map((m,i)=>`<option value="${i}" ${String(i)===(rec?.seasonalMonth||"8")?"selected":""}>${m}</option>`).join("");
  const tracking = sv?.trackingType||"miles";
  const u = unit(tracking);
  const triggers = tracking==="date"
    ? ["Every X Days","Seasonal (Month)"]
    : ["Every X Days","Seasonal (Month)",tracking==="miles"?"Miles":"Hours"];

  return `
  <div class="header">
    <div class="header-row"><h1>${isEdit?"Edit Task":"Add Task"}</h1>
      <button class="small-btn small-btn-white" onclick="go(selVid?'vehicle-detail':'dashboard')">Cancel</button>
    </div>
  </div>
  <div class="section">
    <label>Vehicle *</label>
    <select id="rv" ${isEdit?"disabled":""} onchange="onRVehicle(this.value)">
      <option value="">Select vehicleâ€¦</option>${vOpts}
    </select>
    ${sv?`
    <label>Task *</label>
    ${!rf.customMode
      ?`<select id="rt"><option value="">Select taskâ€¦</option>${taskOpts}</select>
        ${!isEdit?`<button class="btn btn-ghost" style="font-size:12px;margin-top:4px" onclick="rfToggle(true)">ï¼‹ Custom task</button>`:""}`
      :`<input id="rt-custom" value="${esc(rec?.task||"")}" placeholder="e.g. Spark plugs"/>
        <button class="btn btn-ghost" style="font-size:12px;margin-top:4px" onclick="rfToggle(false)">â† Use preset list</button>`
    }
    ${isEdit&&!rf.customMode?`<p class="hint" style="margin-top:4px">Current: <b>${esc(rec.task)}</b> â€” select a different task or <button style="background:none;border:none;color:#100299;font-size:12px;font-weight:600;cursor:pointer;padding:0" onclick="rfToggle(true)">enter custom</button></p>`:""}

    <label>Reminder Type</label>
    <select id="rtt" onchange="onTT(this.value)">
      ${triggers.map(t=>`<option ${t===tt?"selected":""}>${t}</option>`).join("")}
    </select>

    ${tt==="Every X Days"?`
      <label>Last Service Date</label>
      <input id="rldate" type="date" value="${rec?.lastDate||today}"/>
      <label>Repeat Interval (days)</label>
      <input id="rint" type="number" value="${esc(rec?.intervalDays||"")}" placeholder="e.g. 90, 180, 365"/>
      <p class="hint">Every 3 months = 90 Â· 6 months = 180 Â· Yearly = 365</p>`:""}

    ${tt==="Seasonal (Month)"?`
      <label>Every year in:</label>
      <select id="rmonth">${monthOpts}</select>`:""}

    ${tt==="Miles"||tt==="Hours"?`
      <label>Last Service ${tt} Reading</label>
      <input id="rluse" type="number" value="${esc(rec?.lastUsage||"")}" placeholder="${u==="mi"?"e.g. 45000":"e.g. 250"}"/>
      <label>Service Interval (${u})</label>
      <input id="ruse-int" type="number" value="${esc(rec?.usageInterval||"")}" placeholder="${u==="mi"?"e.g. 5000":"e.g. 100"}"/>
      <p class="hint">Next due = last reading + interval. Auto-updates on each service log.</p>`:""}

    <label>Parts &amp; Supplies (optional)</label>
    <input id="rsupplies" value="${esc(rec?.supplies||"")}" placeholder="e.g. 5W-30 oil (5qt), oil filter"/>
    <p class="hint">Shown in your reminder email so you can shop ahead of time.</p>
    <label>Notes (optional)</label>
    <input id="rnotes" value="${esc(rec?.notes||"")}" placeholder="e.g. Torque to 18 ft-lb"/>
    <div id="rerr" class="error-text"></div>
    <button class="btn btn-primary" onclick="${isEdit?"updateRecord()":"saveRecord()"}">
      ${isEdit?"Save Changes":"Save Task"}
    </button>
    ${isEdit?`<button class="btn btn-danger" onclick="delRecord('${rec.id}')">Delete Task</button>`:""}
    `:`<p class="hint" style="margin-top:16px">Select a vehicle to continue.</p>`}
  </div>
  ${nav(isEdit?"":"add-record")}`;
}

function onRVehicle(id){rf.vehicleId=id;selVid=id;render();}
function onTT(v){
  rf.triggerType=v;
  // preserve task selection before re-render
  const t=document.getElementById("rt");
  if(t) rf.savedTask=t.value;
  render();
}
function rfToggle(c){
  // preserve task selection before re-render
  const t=document.getElementById("rt");
  if(t) rf.savedTask=t.value;
  rf.customMode=c;
  render();
}

function collectRecordForm(existingId, vehicleId) {
  const tt = (document.getElementById("rtt")||{value:"Every X Days"}).value;
  const task = rf.customMode
    ? (document.getElementById("rt-custom")||{value:""}).value.trim()
    : (document.getElementById("rt")||{value:""}).value;

  const isMilesHours = tt==="Miles"||tt==="Hours";
  const isDays       = tt==="Every X Days";
  const isSeasonal   = tt==="Seasonal (Month)";

  const r = {
    id:            existingId||genId(),
    vehicleId:     vehicleId||(document.getElementById("rv")||{value:""}).value,
    task,
    triggerType:   tt,
    intervalDays:  isDays       ? (document.getElementById("rint")   ||{value:""}).value : "",
    seasonalMonth: isSeasonal   ? (document.getElementById("rmonth") ||{value:"8"}).value : "",
    lastDate:      isDays       ? (document.getElementById("rldate") ||{value:""}).value : "",
    lastUsage:     isMilesHours ? (document.getElementById("rluse")  ||{value:""}).value : "",
    usageInterval: isMilesHours ? (document.getElementById("ruse-int")||{value:""}).value : "",
    supplies:      (document.getElementById("rsupplies")||{value:""}).value,
    notes:         (document.getElementById("rnotes")   ||{value:""}).value,
  };
  r.nextDueDate  = calcNextDueDate(r);
  r.nextDueUsage = calcNextDueUsage(r);
  return r;
}

async function saveRecord() {
  const vid=(document.getElementById("rv")||{value:""}).value;
  const r=collectRecordForm(null, vid);
  if (!r.vehicleId||!r.task){document.getElementById("rerr").textContent="Vehicle and task are required.";return;}
  syncing=true;
  try {
    const res=await api("saveRecord",{record:r});
    if(res.error) throw new Error(res.error);
    records.push(r); rf={vehicleId:"",triggerType:"Every X Days",customMode:false};
    showToast("Task saved!"); go(selVid?"vehicle-detail":"dashboard",selVid);
  } catch(e){showToast("Save failed: "+e.message);}
  syncing=false;
}

async function updateRecord() {
  if (!editRecord) return;
  const r=collectRecordForm(editRecord.id, editRecord.vehicleId);
  if (!r.task){document.getElementById("rerr").textContent="Task name is required.";return;}
  // Preserve lastUsage/lastDate if not re-entered
  if (!r.lastUsage) r.lastUsage = editRecord.lastUsage;
  if (!r.lastDate)  r.lastDate  = editRecord.lastDate;
  syncing=true;
  try {
    const res=await api("updateRecord",{record:r});
    if(res.error) throw new Error(res.error);
    records=records.map(x=>x.id===r.id?r:x);
    editRecord=null; rf={vehicleId:"",triggerType:"Every X Days",customMode:false};
    showToast("Task updated!"); go("vehicle-detail",selVid);
  } catch(e){showToast("Save failed: "+e.message);}
  syncing=false;
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rSettings() {
  const typeList = VEHICLE_TYPES;
  const vehicleList = vehicles;

  // Tab selector
  const typeTabs = `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
    ${typeList.map(t=>`<button onclick="settingsTab='${t}';render()"
      style="padding:5px 10px;border-radius:99px;border:1.5px solid ${settingsTab===t?'#100299':'#d1d5db'};
      background:${settingsTab===t?'#100299':'#fff'};color:${settingsTab===t?'#fff':'#374151'};
      font-size:12px;font-weight:600;cursor:pointer">${t}</button>`).join("")}
  </div>
  <div style="height:1px;background:#f0f0f0;margin:8px 0 12px"></div>
  <div style="font-size:12px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Per Vehicle</div>
  <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px">
    ${vehicleList.map(v=>`<button onclick="settingsTab='${v.id}';render()"
      style="padding:5px 10px;border-radius:99px;border:1.5px solid ${settingsTab===v.id?'#100299':'#d1d5db'};
      background:${settingsTab===v.id?'#100299':'#fff'};color:${settingsTab===v.id?'#fff':'#374151'};
      font-size:12px;font-weight:600;cursor:pointer">${esc(v.name)}</button>`).join("")}
  </div>`;

  // Current preset list for selected tab
  const isVehicle = vehicles.some(v=>v.id===settingsTab);
  const scopeLabel = isVehicle
    ? `<p class="hint" style="margin-bottom:8px">Custom tasks for <b>${esc(vehicles.find(v=>v.id===settingsTab)?.name)}</b> only. Shown in addition to type presets.</p>`
    : `<p class="hint" style="margin-bottom:8px">Default task list for all <b>${settingsTab}</b> vehicles. Per-vehicle lists override these.</p>`;

  const currentList = customPresets[settingsTab] || (isVehicle ? [] : DEFAULT_PRESETS[settingsTab] || []);

  const items = currentList.map((task,i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f0f0f0">
      <span style="flex:1;font-size:14px">${esc(task)}</span>
      <button class="small-btn small-btn-red" onclick="removePresetItem('${settingsTab}',${i})">Remove</button>
    </div>`).join("");

  return `
  <div class="header">
    <div class="header-row"><h1>Settings</h1></div>
  </div>
  <div class="section">
    <div class="section-label">Task Presets</div>
    <p class="hint" style="margin-bottom:12px">Customize the task dropdown when adding maintenance. Select a vehicle type or a specific vehicle.</p>
    <div class="card" style="padding:12px">
      ${typeTabs}
      ${scopeLabel}
      ${items || `<p style="color:#9ca3af;font-size:13px;padding:8px 0">${isVehicle?"No custom tasks yet â€” add one below.":"Using defaults â€” add items to customize."}</p>`}
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="new-preset" placeholder="New task nameâ€¦" style="flex:1;margin-top:0"/>
        <button class="btn btn-primary" style="width:auto;margin-top:0;padding:10px 16px" onclick="addPresetItem('${settingsTab}')">Add</button>
      </div>
      ${!isVehicle && customPresets[settingsTab]?.length
        ? `<button class="btn btn-ghost" style="font-size:12px;margin-top:8px" onclick="resetPresets('${settingsTab}')">Reset to defaults</button>`
        : ""}
    </div>
    <button class="btn btn-primary" id="save-presets-btn" onclick="savePresetsToSheet()" style="margin-top:16px">Save &amp; Sync to Sheet</button>
    <p class="hint">Presets are also saved locally so they load instantly.</p>
  </div>
  ${nav("settings")}`;
}

function addPresetItem(scope) {
  const input = document.getElementById("new-preset");
  const val = (input.value||"").trim();
  if (!val) return;
  if (!customPresets[scope]) {
    // seed with defaults if type scope
    const isVehicle = vehicles.some(v=>v.id===scope);
    customPresets[scope] = isVehicle ? [] : [...(DEFAULT_PRESETS[scope]||[])];
  }
  if (!customPresets[scope].includes(val)) customPresets[scope].push(val);
  input.value = "";
  localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
  render();
}

function removePresetItem(scope, idx) {
  if (!customPresets[scope]) {
    const isVehicle = vehicles.some(v=>v.id===scope);
    customPresets[scope] = isVehicle ? [] : [...(DEFAULT_PRESETS[scope]||[])];
  }
  customPresets[scope].splice(idx, 1);
  localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
  render();
}

function resetPresets(type) {
  if (!confirm(`Reset ${type} presets to defaults?`)) return;
  delete customPresets[type];
  localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
  render();
}

async function savePresetsToSheet() {
  const btn = document.getElementById("save-presets-btn");
  btn.disabled = true; btn.textContent = "Savingâ€¦";
  try {
    const res = await api("savePresets", { presets: customPresets });
    if (res.error) throw new Error(res.error);
    showToast("Presets saved to sheet!");
  } catch(e) { showToast("Save failed: "+e.message); }
  btn.disabled = false; btn.textContent = "Save & Sync to Sheet";
}
function rDetail() {
  const v=vehicles.find(x=>x.id===selVid);
  if (!v) return `<div class="section"><p class="empty">Vehicle not found.</p></div>${nav("")}`;
  const sr=sorted(selVid), u=unit(v.trackingType);

  const tasks = sr.length===0
    ?`<p class="empty" style="margin-top:16px">No tasks yet.</p>`
    :sr.map(r=>{
        const d=estimateDays(r);
        return `
        <div class="card">
          <div class="task-row">
            <div style="flex:1">
              <div class="task-title">${esc(r.task)}</div>
              <div class="task-meta">${r.triggerType} Â· ${dueLabel(r)}</div>
              ${r.supplies?`<div class="task-supplies">ğŸ›’ ${esc(r.supplies)}</div>`:""}
              ${r.notes?`<div class="task-notes">${esc(r.notes)}</div>`:""}
            </div>
            <span class="badge ${badgeClass(d)}">${badgeLabel(d)}</span>
          </div>
          <div class="task-actions">
            <button class="small-btn small-btn-green" onclick="openLog('${r.id}')">âœ“ Log Done</button>
            ${r.nextDueDate?`<button class="small-btn small-btn-blue" onclick="openCal('${r.id}')">ğŸ“… Cal</button>`:""}
            <button class="small-btn small-btn-gray" onclick="openEditRecord('${r.id}')">âœï¸ Edit</button>
            <button class="small-btn small-btn-red" onclick="delRecord('${r.id}')">Delete</button>
          </div>
        </div>`;
      }).join("");

  return `
  <div class="header">
    <div class="header-row">
      <div><h1>${esc(v.name)}</h1><p>${v.year?esc(v.year)+" ":""}${esc(v.type)}${v.notes?" Â· "+esc(v.notes):""}</p></div>
      <div style="display:flex;gap:6px">
        <button class="small-btn small-btn-white" onclick="openEditVehicle('${v.id}')">âœï¸ Edit</button>
        <button class="small-btn small-btn-white" onclick="go('vehicles')">Back</button>
      </div>
    </div>
  </div>
  <div class="section">
    ${u?`<div style="margin-bottom:12px">
      ${v.currentUsage?`<span class="pill">ğŸ“ ${fNum(v.currentUsage)} ${u}</span>`:""}
      ${v.avgWeeklyUsage?`<span class="pill">~${fNum(v.avgWeeklyUsage)} ${u}/wk</span>`:""}
    </div>`:""}
    <button class="btn btn-outline" onclick="go('add-record','${v.id}')">ï¼‹ Add Maintenance Task</button>
    <div class="divider"></div>
    ${tasks}
  </div>
  ${nav("")}`;
}

// â”€â”€ LOG DONE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLog(rid) {
  logRec=records.find(r=>r.id===rid);
  if (!logRec) return;
  const v=vehicles.find(x=>x.id===logRec.vehicleId)||{};
  const u=unit(v.trackingType);
  const needsUsage=logRec.triggerType==="Miles"||logRec.triggerType==="Hours";
  const today=new Date().toISOString().slice(0,10);

  document.getElementById("modal").innerHTML=`
  <div class="modal-bg" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h2>Log Service</h2>
      <p class="sub">${esc(v.name)} â€” ${esc(logRec.task)}</p>
      <div class="divider"></div>
      <label>Date of Service</label>
      <input id="ld" type="date" value="${today}"/>
      ${needsUsage?`
        <label>${u==="mi"?"Odometer Reading (miles)":"Engine Hours Reading"}</label>
        <input id="lu" type="number" placeholder="${v.currentUsage?`Last: ${fNum(v.currentUsage)} ${u}`:`Current ${u==="mi"?"mileage":"hours"}`}"/>
        <p class="hint">Current reading on your ${u==="mi"?"odometer":"hour meter"}. Used to recalculate your weekly average and predict the next service.</p>`:""}
      <label>Notes (optional)</label>
      <input id="ln" placeholder="e.g. Mobil 1 5W-30, replaced both front pads"/>
      <button class="btn btn-primary" onclick="submitLog()" style="margin-top:16px">Save &amp; Schedule Next</button>
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    </div>
  </div>`;
}

function closeModal(){document.getElementById("modal").innerHTML="";logRec=null;}

async function submitLog() {
  if (!logRec) return;
  const date=(document.getElementById("ld")||{value:""}).value;
  const usage=(document.getElementById("lu")||{value:""}).value;
  const notes=(document.getElementById("ln")||{value:""}).value;
  if (!date){showToast("Date is required.");return;}
  const entry={id:genId(),vehicleId:logRec.vehicleId,recordId:logRec.id,task:logRec.task,date,usageAtService:usage,notes};
  syncing=true;
  try {
    const res=await api("logService",{entry});
    if(res.error) throw new Error(res.error);
    await loadAll();
    showToast("Logged! Next service date updated.");
    closeModal(); render();
  } catch(e){showToast("Failed: "+e.message);}
  syncing=false;
}

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function delRecord(id) {
  if (!confirm("Delete this task?")) return;
  syncing=true;
  try {
    await api("deleteRecord",{id});
    records=records.filter(r=>r.id!==id);
    showToast("Task deleted."); render();
  } catch(e){showToast("Failed: "+e.message);}
  syncing=false;
}

async function delVehicle(id) {
  const v=vehicles.find(x=>x.id===id);
  if (!confirm(`Delete ${v?.name} and all its tasks? Cannot be undone.`)) return;
  syncing=true;
  try {
    await api("deleteVehicle",{id});
    vehicles=vehicles.filter(x=>x.id!==id);
    records=records.filter(r=>r.vehicleId!==id);
    editVehicle=null; showToast("Deleted."); go("vehicles");
  } catch(e){showToast("Failed: "+e.message);}
  syncing=false;
}

function openCal(rid) {
  const r=records.find(x=>x.id===rid);
  const v=vehicles.find(x=>x.id===r?.vehicleId);
  if (!r?.nextDueDate){showToast("No due date â€” use a date-based trigger.");return;}
  const d=r.nextDueDate.replace(/-/g,"");
  window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent((v?.name||"")+" - "+r.task)}&dates=${d}/${d}&details=${encodeURIComponent(r.notes||"")}`, "_blank");
}

// â”€â”€ APPS SCRIPT: also needs updateVehicle action â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (handled server-side â€” see Apps Script artifact)

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  render();
  if (SCRIPT_URL) {
    try { await loadAll(); go("dashboard"); }
    catch(e) { SCRIPT_URL=""; localStorage.removeItem(URL_KEY); go("setup"); showToast("Reconnect required."); }
  }
}
init();
</script>
</body>
</html>
